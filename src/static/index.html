<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>drcv upload (multi resumable)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-200 font-mono min-h-screen flex flex-col items-center py-10">
  <h1 class="text-3xl font-bold text-green-400 mb-6">drcv uploader</h1>
  <p id="share-url" class="mb-4 text-sm text-gray-400"></p>
  
  <div class="w-full max-w-xl bg-gray-800 p-6 rounded-lg shadow-lg">
    <input id="files" type="file" multiple 
      class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4
             file:rounded-full file:border-0 file:text-sm file:font-semibold
             file:bg-green-600 file:text-white hover:file:bg-green-500 mb-4"/>
    <button id="uploadBtn" 
      class="w-full py-2 px-4 bg-green-600 hover:bg-green-500 rounded font-bold text-gray-900 mb-4">
      Upload
    </button>

    <h2 class="text-lg font-semibold mb-2">Current Uploads</h2>
    <div id="progress-container" class="space-y-4"></div>

    <h2 class="text-lg font-semibold mt-6 mb-2">Upload History</h2>
    <ul id="history" class="text-sm space-y-1"></ul>
  </div>

  <script>
    // Show the URL to share (useful when accessed via {hash}.drcv.app)
    (function(){
      const el = document.getElementById('share-url');
      const host = window.location.host;
      const proto = window.location.protocol;
      el.textContent = `Share this URL: ${proto}//${host}`;
    })();

    const CHUNK_SIZE = (window.DRCV_CONFIG && window.DRCV_CONFIG.chunkSize) || (4 * 1024 * 1024); // default 4MB
    const fileInput = document.getElementById('files');
    const btn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('progress-container');
    const historyList = document.getElementById('history');
    
    // 활성 업로드 ID들 관리
    const activeUploadIds = new Set();
    let heartbeatInterval = null;

    // --- Load history from localStorage ---
    function loadHistory() {
      const history = JSON.parse(localStorage.getItem("drcv-history") || "[]");
      historyList.innerHTML = "";
      history.forEach(item => {
        const li = document.createElement("li");
        const status = item.status || 'completed'; // 기존 데이터는 completed로 처리
        const statusIcon = status === 'completed' ? '✅' : status === 'canceled' ? '❌' : '⏸️';
        const statusText = status === 'completed' ? '' : ` (${status})`;
        li.textContent = `${statusIcon} ${item.filename}${statusText} (${new Date(item.date).toLocaleString()})`;
        historyList.appendChild(li);
      });
    }

    // --- Save history entry ---
    function saveHistory(filename, status = 'completed') {
      const history = JSON.parse(localStorage.getItem("drcv-history") || "[]");
      history.unshift({ filename, date: new Date().toISOString(), status }); // unshift로 맨 앞에 추가
      localStorage.setItem("drcv-history", JSON.stringify(history));
      loadHistory();
    }

    // 통합 heartbeat 함수
    function startHeartbeat() {
      if (heartbeatInterval) return; // 이미 실행 중
      
      const beat = async () => {
        if (activeUploadIds.size === 0) {
          // 활성 업로드가 없으면 heartbeat 중지
          clearInterval(heartbeatInterval);
          heartbeatInterval = null;
          return;
        }
        
        try {
          const response = await fetch('/heartbeat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ upload_ids: Array.from(activeUploadIds) })
          });
          const result = await response.text();
          console.log('Heartbeat result:', result);
        } catch (e) {
          console.log('Heartbeat failed:', e);
        }
      };

      // 즉시 한 번 보내고, 이후 주기적으로 보냄
      beat();
      heartbeatInterval = setInterval(beat, 10000); // 10초마다
    }

    loadHistory();

    // Upload multiple files with limited concurrency
    btn.addEventListener('click', async () => {
      const files = Array.from(fileInput.files || []);
      if (!files.length) return alert("Select files first");
      progressContainer.innerHTML = "";

      const limit = 3; // parallel uploads for multiple files
      let idx = 0;
      const workers = Array.from({ length: Math.min(limit, files.length) }, async () => {
        while (idx < files.length) {
          const myIndex = idx++;
          const f = files[myIndex];
          await uploadFile(f);
        }
      });
      await Promise.all(workers);
    });

    async function uploadFile(file) {
      // Create progress row
      const wrapper = document.createElement("div");
      wrapper.className = "bg-gray-700 p-3 rounded";

      const title = document.createElement("div");
      title.textContent = file.name;
      title.className = "mb-2 text-sm font-bold";
      
      let uploadId = null;

      const progressWrapper = document.createElement("div");
      progressWrapper.className = "mb-2";
      
      const progress = document.createElement("progress");
      progress.max = 100;
      progress.value = 0;
      progress.className = "w-full h-3";
      
      const progressText = document.createElement("div");
      progressText.textContent = "0% • 0 KB/s";
      progressText.className = "text-xs text-gray-400 mt-1";
      
      progressWrapper.appendChild(progress);
      progressWrapper.appendChild(progressText);

      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "Cancel";
      cancelBtn.className = "px-3 py-1 bg-red-600 hover:bg-red-500 rounded text-xs font-bold text-white";
      
      let isCanceled = false;
      cancelBtn.addEventListener('click', () => {
        isCanceled = true;
        wrapper.style.opacity = "0.5";
        cancelBtn.disabled = true;
        cancelBtn.textContent = "Canceled";
        cancelBtn.className = "px-3 py-1 bg-gray-500 rounded text-xs font-bold text-white cursor-not-allowed";
        saveHistory(file.name, 'canceled');
        
        // 활성 업로드 목록에서 제거
        if (uploadId) {
          activeUploadIds.delete(parseInt(uploadId));
        }
      });

      wrapper.appendChild(title);
      wrapper.appendChild(progressWrapper);
      wrapper.appendChild(cancelBtn);
      progressContainer.appendChild(wrapper);

      // 1. Check resume status
      const headResp = await fetch(`/upload?filename=${encodeURIComponent(file.name)}`, { method: "HEAD" });
      let uploadedBytes = parseInt(headResp.headers.get("x-uploaded-bytes") || "0");
      const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
      let startChunk = Math.floor(uploadedBytes / CHUNK_SIZE);
      let emaBps = null; // exponential moving average of bytes/sec

      // 2. Upload remaining chunks
      for (let i = startChunk; i < totalChunks; i++) {
        if (isCanceled) {
          console.log(`Upload canceled for ${file.name}`);
          return;
        }

        const start = i * CHUNK_SIZE;
        const end = Math.min(start + CHUNK_SIZE, file.size);
        const blob = file.slice(start, end);

        const formData = new FormData();
        formData.append("chunk", blob);
        formData.append("filename", file.name);
        formData.append("chunk_index", i);
        formData.append("total_chunks", totalChunks);

        const tStart = performance.now();
        const response = await fetch("/upload", { method: "POST", body: formData });
        const tEnd = performance.now();
        if (!response.ok) {
          const errorText = await response.text();
          alert(`❌ Upload failed: ${errorText}`);
          return;
        }
        
        // 첫 번째 chunk 업로드 후 uploadId 추출
        if (i === startChunk && !uploadId) {
          uploadId = await response.text();
          console.log("Upload ID:", uploadId);
          
          // 활성 업로드 목록에 추가 및 heartbeat 시작
          activeUploadIds.add(parseInt(uploadId));
          startHeartbeat();
        }

        // Update progress percent and speed
        const elapsedSec = Math.max((tEnd - tStart) / 1000, 0.001);
        const instBps = blob.size / elapsedSec;
        emaBps = emaBps == null ? instBps : (emaBps * 0.7 + instBps * 0.3);
        const progressPercent = (((i + 1) / totalChunks) * 100).toFixed(1);
        progress.value = parseFloat(progressPercent);
        progressText.textContent = `${progressPercent}% • ${formatSpeed(emaBps)}`;
      }

      // 활성 업로드 목록에서 제거
      if (uploadId) {
        activeUploadIds.delete(parseInt(uploadId));
      }
      
      if (!isCanceled) {
        saveHistory(file.name);
        // 완료된 업로드를 current uploads에서 제거
        wrapper.remove();
      }
    }

    function formatSpeed(bps) {
      if (!isFinite(bps) || bps <= 0) return '0 KB/s';
      const KB = 1024;
      const MB = KB * 1024;
      if (bps >= MB) return `${(bps / MB).toFixed(1)} MB/s`;
      if (bps >= KB) return `${(bps / KB).toFixed(1)} KB/s`;
      return `${Math.max(1, Math.round(bps))} B/s`;
    }
  </script>
</body>
</html>
